{% extends "../example/base.html" %}

{% load static %} 

{% block style %}
<link rel="stylesheet" href="{% static 'styles/page_styles/routine_ing_component.css' %}" />
{% endblock style %} 

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const routineData = Array.from(document.querySelectorAll('.detail_box')).map((box) => {
        const durationStr = box.getAttribute('data-duration');
        const [minutes, seconds] = durationStr.split(':').map(Number);

        // 이미지 배열: data-image-urls JSON으로 받음
        const imageUrls = JSON.parse(box.getAttribute('data-image-urls') || '["' + box.getAttribute('data-image-url') + '"]');

        return {
            durationInSeconds: (minutes * 60) + seconds,
            durationString: durationStr,
            element: box,
            imageUrls: imageUrls,
            currentImageIndex: 0
        };
    });

    const progressBars = document.querySelectorAll('.progress');
    const timeTexts = document.querySelectorAll('.time-text');
    const routineImage = document.getElementById('routine_image');
    const stepNumberElement = document.getElementById('step_number');
    const prevButton = document.getElementById('photo_prev');
    const nextButton = document.getElementById('photo_next');
    const totalSteps = routineData.length;

    let currentStepIndex = 0;
    let timerInterval = null;

    function startTimer(step) {
        if (timerInterval) clearInterval(timerInterval);

        const exercise = routineData[step];
        let timeRemaining = exercise.durationInSeconds;
        const progressBar = progressBars[step];
        const timeText = timeTexts[step];
        const circumference = 2 * Math.PI * 30;

        progressBars.forEach((pb, idx) => {
            pb.style.strokeDasharray = circumference;
            pb.style.strokeDashoffset = circumference;
            timeTexts[idx].textContent = routineData[idx].durationString;
            timeTexts[idx].closest('.step').classList.remove('completed');
        });

        for (let i = 0; i < step; i++) {
            progressBars[i].style.strokeDashoffset = 0;
            timeTexts[i].textContent = "완료!";
            timeTexts[i].closest('.step').classList.add('completed');
        }

        timerInterval = setInterval(() => {
            if (timeRemaining > 0) {
                timeRemaining--;
                const progress = (exercise.durationInSeconds - timeRemaining) / exercise.durationInSeconds;
                const offset = circumference - progress * circumference;
                progressBar.style.strokeDashoffset = offset;

                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                timeText.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            } else {
                clearInterval(timerInterval);
                timeText.textContent = "완료!";
                timeText.style.fontSize = "13px";
                timeText.closest('.step').classList.add('completed');

                if (currentStepIndex < totalSteps - 1) {
                    currentStepIndex++;
                    updateRoutineUI(currentStepIndex);
                    startTimer(currentStepIndex);
                } else {
                  document.getElementById("finishForm").submit();
                }
            }
        }, 1000);
    }

    function updateRoutineUI(step) {
        const currentExercise = routineData[step];
        routineImage.src = currentExercise.imageUrls[currentExercise.currentImageIndex];
        stepNumberElement.textContent = step + 1;

        document.querySelectorAll('.detail_box').forEach((box, index) => {
            box.style.display = (index === step) ? 'flex' : 'none';
        });
        document.querySelectorAll('.step').forEach((stepEl, index) => {
            stepEl.classList.toggle('active', index === step);
        });
    }

    // 좌우 버튼 이미지 전환
    prevButton.addEventListener('click', () => {
        const exercise = routineData[currentStepIndex];
        exercise.currentImageIndex--;
        if (exercise.currentImageIndex < 0) exercise.currentImageIndex = exercise.imageUrls.length - 1;
        routineImage.src = exercise.imageUrls[exercise.currentImageIndex];
    });

    nextButton.addEventListener('click', () => {
        const exercise = routineData[currentStepIndex];
        exercise.currentImageIndex++;
        if (exercise.currentImageIndex >= exercise.imageUrls.length) exercise.currentImageIndex = 0;
        routineImage.src = exercise.imageUrls[exercise.currentImageIndex];
    });

    // 초기 UI
    updateRoutineUI(currentStepIndex);
    startTimer(currentStepIndex);

document.getElementById('finishBtn').addEventListener('click', (e) => {
  e.preventDefault(); // 혹시 submit 전에 JS 처리 필요할 때
  const routineItems = Array.from(document.querySelectorAll('.routine_item'));
  const routinesToSend = routineItems.map(item => {
    const tableRows = item.querySelectorAll('table tr');
    return Array.from(tableRows).map(row => {
      const cells = row.querySelectorAll('td, th');
      return {
        id: cells[0].textContent.trim(),
        img: cells[1].querySelector('img').getAttribute('src'),
        name: cells[2].textContent.trim(),
        duration: cells[3].textContent.trim(),
        part: cells[4].textContent.trim(),
      };
    });
  });

  document.getElementById('finish_exercise_routine').value = JSON.stringify(routinesToSend);
  document.getElementById('finishForm').submit();
});
});
</script>

{% endblock script %}



{% block body %} 
  {% block header %}
    {% include "../components/header_component.html" %}
  {% endblock header %}

  <div class="bighugger">
    <div class="photobox_wrapper">
      <div class="photobox_nav photobox_prev" id="photo_prev">
        <img src="{% static 'assets/img/left.png' %}" alt="왼쪽" class="left_right">
      </div>
      <div class="step_number" id="step_number">1</div>
      <img src="/media/{{ exercise_routine.0.exercise.detail_images.0 }}" alt="운동 이미지" id="routine_image">
      <div class="photobox_nav photobox_next" id="photo_next">
        <img src="{% static 'assets/img/right.png' %}" alt="오른쪽" class="left_right">
      </div>
    </div>

    <div class="routinesection">
      <div class="timeline" id="timeline">
        {% for item in exercise_routine %}
          <div class="step">
            <div class="circle">
              <svg width="80" height="80" style="transform: rotate(90deg) scale(-1,1); overflow: visible">
                <defs>
                  <linearGradient id="purpleGradient_{{ forloop.counter }}" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#A48BE7"/>
                    <stop offset="100%" stop-color="#E0CFFF"/>
                  </linearGradient>
                </defs>

                <circle cx="40" cy="40" r="30" stroke="#eee" stroke-width="7" fill="none" />
                <circle cx="40" cy="40" r="30" stroke="url(#purpleGradient_{{ forloop.counter }})" stroke-width="7"
        fill="none" stroke-dasharray="188.4" stroke-dashoffset="188.4" stroke-linecap="round" class="progress"/>

              </svg>
              <div class="time-text">{{ item.exercise.duration|slice:"3:" }}</div>
            </div>
          </div>
          {% if not forloop.last %}
            <div class="chain"></div>
          {% endif %}
        {% endfor %}
      </div>

      {% for item in exercise_routine %}
        <div class="detail_box" 
            data-index="{{ forloop.counter0 }}" 
            data-duration="{{ item.exercise.duration|slice:"3:" }}" 
            data-image-urls='[
                "{{ item.exercise.image1 }}",
                "{{ item.exercise.image2 }}",
                "{{ item.exercise.image3 }}"
            ]'
            style="{% if forloop.first %}display:flex{% else %}display:none{% endif %}">
        <img src="{% static 'assets/img/happy_pipi_hugging.png' %}" alt="웃는피피" class="happy_pipi_hugging"/>
        <div class="hugger">
          <div>
            <span id="step_content">{{ item.exercise.name }}</span>
            <span id="category">{{ item.exercise.category }}</span>
          </div>
          <div>
            <span>난이도</span>
            <span>
              <div class="starscore">
                {% for i in "12345"|make_list %}
                  {% if forloop.counter <= item.exercise.difficulty %}
                    <span class="star_per">
                      <img src="{% static 'assets/img/star_purple.png' %}" alt="보라별" />
                    </span>
                  {% else %}
                    <span class="star_per">
                      <img src="{% static 'assets/img/star_gray.png' %}" alt="회색별" />
                    </span>
                  {% endif %}
                {% endfor %}
              </div>
            </span>
          </div>
        </div>
        <div class="detail_description_box">
          <ul class="detail_lists">
            {% for desc in item.exercise.description_list %}
              <li>{{ desc }}</li> <!--description들이 나눠진 걸 가정하고 코드를 작성해서 지금상태에서는 아무것도 안 뜹니다!-->
            {% endfor %}
          </ul>
        </div>
      </div>
    {% endfor %}
    </div>
  </div>

  <a href="{% url 'frontend:cyclepage' %}" class="back_button">
    <img src="{% static 'assets/img/left.png' %}" alt="뒤로가기" />
  </a>
