{% extends "../example/base.html" %}

{% load static %} 

{% block style %}
<link rel="stylesheet" href="{% static 'styles/page_styles/routine_ing_component.css' %}" />
{% endblock style %} 

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const routineData = Array.from(document.querySelectorAll('.detail_box')).map((box) => {
        const durationStr = box.getAttribute('data-duration');
        const [minutes, seconds] = durationStr.split(':').map(Number);
        
        return {
            durationInSeconds: (minutes * 60) + seconds,
            durationString: durationStr,
            element: box,
            imagePath: box.getAttribute('data-image-url')
        };
    });

    const progressBars = document.querySelectorAll('.progress');
    const timeTexts = document.querySelectorAll('.time-text');
    const routineImage = document.getElementById('routine_image');
    const stepNumberElement = document.getElementById('step_number');
    const prevButton = document.getElementById('photo_prev');
    const nextButton = document.getElementById('photo_next');
    const totalSteps = routineData.length;

    let currentStepIndex = 0;
    let timerInterval = null;

    function startTimer(step) {
        if (timerInterval) {
            clearInterval(timerInterval);
        }

        const exercise = routineData[step];
        let timeRemaining = exercise.durationInSeconds;

        const progressBar = progressBars[step];
        const timeText = timeTexts[step];
        const circumference = 2 * Math.PI * 30;

        progressBars.forEach((pb, idx) => {
            pb.style.strokeDasharray = circumference;
            pb.style.strokeDashoffset = circumference;
            
            timeTexts[idx].textContent = routineData[idx].durationString;
            timeTexts[idx].closest('.step').classList.remove('completed');
        });

        for (let i = 0; i < step; i++) {
            progressBars[i].style.strokeDashoffset = 0;
            timeTexts[i].textContent = "ÏôÑÎ£å!";
            timeTexts[i].closest('.step').classList.add('completed');
        }


        timerInterval = setInterval(() => {
            if (timeRemaining > 0) {
                timeRemaining--;
                const progress = (exercise.durationInSeconds - timeRemaining) / exercise.durationInSeconds;
                const offset = circumference - progress * circumference;
                progressBar.style.strokeDashoffset = offset;

                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                timeText.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            } else {
                clearInterval(timerInterval);
                timeText.textContent = "ÏôÑÎ£å!";
                timeText.style.fontSize = "13px";
                timeText.closest('.step').classList.add('completed');

                if (currentStepIndex < totalSteps - 1) {
                    currentStepIndex++;
                    updateRoutineUI(currentStepIndex);
                    startTimer(currentStepIndex);
                } else {
                    alert("Î£®Ìã¥ÏùÑ ÏôÑÎ£åÌñàÏäµÎãàÎã§! üéâ");
                }
            }
        }, 1000);
    }

    function updateRoutineUI(step) {
        const currentExercise = routineData[step];
        routineImage.src = currentExercise.imagePath;
        stepNumberElement.textContent = step + 1;
        document.querySelectorAll('.detail_box').forEach((box, index) => {
            box.style.display = (index === step) ? 'flex' : 'none';
        });
        document.querySelectorAll('.step').forEach((stepEl, index) => {
            stepEl.classList.toggle('active', index === step);
        });
    }

    updateRoutineUI(currentStepIndex);
    startTimer(currentStepIndex);
});
</script>
{% endblock script %}



{% block body %} 
  {% block header %}
    {% include "../components/header_component.html" %}
  {% endblock header %}

  <div class="bighugger">
    <div class="photobox_wrapper">
      <div class="photobox_nav photobox_prev" id="photo_prev">
        <img src="{% static 'assets/img/left.png' %}" alt="ÏôºÏ™Ω" class="left_right">
      </div>
      <div class="step_number" id="step_number">1</div>
      <img src="/media/{{ exercise_routine.0.exercise.detail_images.0 }}" alt="Ïö¥Îèô Ïù¥ÎØ∏ÏßÄ" id="routine_image">
      <div class="photobox_nav photobox_next" id="photo_next">
        <img src="{% static 'assets/img/right.png' %}" alt="Ïò§Î•∏Ï™Ω" class="left_right">
      </div>
    </div>

    <div class="routinesection">
      <div class="timeline" id="timeline">
        {% for item in exercise_routine %}
          <div class="step">
            <div class="circle">
              <svg width="80" height="80" style="transform: rotate(90deg) scale(-1,1); overflow: visible">
                <defs>
                  <linearGradient id="purpleGradient_{{ forloop.counter }}" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#A48BE7"/>
                    <stop offset="100%" stop-color="#E0CFFF"/>
                  </linearGradient>
                </defs>

                <circle cx="40" cy="40" r="30" stroke="#eee" stroke-width="7" fill="none" />
                <circle cx="40" cy="40" r="30" stroke="url(#purpleGradient_{{ forloop.counter }})" stroke-width="7"
        fill="none" stroke-dasharray="188.4" stroke-dashoffset="188.4" stroke-linecap="round" class="progress"/>

              </svg>
              <div class="time-text">{{ item.exercise.duration|slice:"3:" }}</div>
            </div>
          </div>
          {% if not forloop.last %}
            <div class="chain"></div>
          {% endif %}
        {% endfor %}
      </div>

      {% for item in exercise_routine %}
        <div class="detail_box" 
            data-index="{{ forloop.counter0 }}" 
            data-duration="{{ item.exercise.duration|slice:"3:" }}" 
            data-image-url="/media/{{ item.exercise.image }}"
            style="{% if forloop.first %}display:flex{% else %}display:none{% endif %}">
        <img src="{% static 'assets/img/happy_pipi_hugging.png' %}" alt="ÏõÉÎäîÌîºÌîº" class="happy_pipi_hugging"/>
        <div class="hugger">
          <div>
            <span id="step_content">{{ item.exercise.name }}</span>
            <span id="category">{{ item.exercise.category }}</span>
          </div>
          <div>
            <span>ÎÇúÏù¥ÎèÑ</span>
            <span>
              <div class="starscore">
                {% for i in "12345"|make_list %}
                  {% if forloop.counter <= item.exercise.difficulty %}
                    <span class="star_per">
                      <img src="{% static 'assets/img/star_purple.png' %}" alt="Î≥¥ÎùºÎ≥Ñ" />
                    </span>
                  {% else %}
                    <span class="star_per">
                      <img src="{% static 'assets/img/star_gray.png' %}" alt="ÌöåÏÉâÎ≥Ñ" />
                    </span>
                  {% endif %}
                {% endfor %}
              </div>
            </span>
          </div>
        </div>
        <div class="detail_description_box">
          <ul class="detail_lists">
            {% for desc in item.exercise.description_list %}
              <li>{{ desc }}</li> <!--descriptionÎì§Ïù¥ ÎÇòÎà†ÏßÑ Í±∏ Í∞ÄÏ†ïÌïòÍ≥† ÏΩîÎìúÎ•º ÏûëÏÑ±Ìï¥ÏÑú ÏßÄÍ∏àÏÉÅÌÉúÏóêÏÑúÎäî ÏïÑÎ¨¥Í≤ÉÎèÑ Ïïà ÎúπÎãàÎã§!-->
            {% endfor %}
          </ul>
        </div>
      </div>
    {% endfor %}
    </div>
  </div>

  <a href="{% url 'frontend:cyclepage' %}" class="back_button">
    <img src="{% static 'assets/img/left.png' %}" alt="Îí§Î°úÍ∞ÄÍ∏∞" />
  </a>
{% endblock body %}
